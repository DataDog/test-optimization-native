# Stage 1: Build the static library using musl (Alpine)
FROM golang:1-alpine AS builder

# Install dependencies for the static build with musl and cgo
RUN apk add --no-cache gcc musl-dev build-base

# Allow changing the architecture during the build if needed
ARG GOARCH=amd64
# Option to link libresolv explicitly for arm64, set to "true" or "false" at build time.
ARG LINK_LIBRESOLV=false

# Configure environment variables for compilation
ENV CGO_ENABLED=1 \
    GOOS=linux \
    GOARCH=$GOARCH \
    # Default CC for amd64 (para arm64 se cambiará más abajo)
    CC="gcc -static" \
    CGO_CFLAGS="-O2 -s -DNDEBUG -fdata-sections -ffunction-sections" \
    CGO_LDFLAGS="-static -s -Wl,--gc-sections"

# Set working directory
WORKDIR /app

# Copy all code to the container
COPY . .

# Change to the directory where the code to compile is located
WORKDIR /app/internal/civisibility/native

# Conditional compilation based on architecture and linking option
RUN if [ "$GOARCH" = "arm64" ]; then \
      echo "Compilando para arm64 usando musl-gcc -static"; \
      export CC="musl-gcc -static"; \
      if [ "$LINK_LIBRESOLV" = "true" ]; then \
          EXTRA="-lresolv"; \
      else \
          EXTRA=""; \
      fi; \
      echo "Flags extra del linker: $EXTRA"; \
      go build -tags "civisibility_native netgo" -buildmode=c-archive \
      -ldflags="-extldflags '-static $EXTRA' -s -w" \
      -o ./output/static/libtestoptimization.a *.go; \
    else \
      echo "Compilando para amd64"; \
      go build -tags "civisibility_native netgo" -buildmode=c-archive \
      -ldflags="-extldflags '-static' -s -w" \
      -o ./output/static/libtestoptimization.a *.go; \
    fi

# Optimizar la librería eliminando símbolos innecesarios
RUN strip --strip-unneeded ./output/static/libtestoptimization.a

# Stage 2: Package the library
FROM alpine:latest

# Rename the final file using build args
ARG FILE_NAME=libtestoptimization

# Install zip to compress the files
RUN apk add --no-cache zip

# Create the output directory
RUN mkdir -p /output/static

# Copy the library and header from the builder stage
COPY --from=builder /app/internal/civisibility/native/output/static/libtestoptimization.a /output/static/libtestoptimization.a
COPY --from=builder /app/internal/civisibility/native/output/static/libtestoptimization.h /output/static/libtestoptimization.h

# Compress the library and header in a zip archive
RUN cd /output/static && zip -j -9 ../${FILE_NAME}-static.zip *.*

# Create a SHA256 checksum file for the zip to verify integrity
RUN sha256sum /output/${FILE_NAME}-static.zip > /output/${FILE_NAME}-static.zip.sha256sum

# Clean up intermediate files
RUN rm -r /output/static

# When the container starts, list the content and copy the files to a destination directory
ENTRYPOINT ["sh", "-c", "ls /output && cp /output/*.* /libtestoptimization && echo 'Static library copied.'"]
